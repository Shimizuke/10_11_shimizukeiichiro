<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>ajax</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css"
        integrity="sha384-GJzZqFGwb1QTTN6wy59ffF1BuGJpLSa9DkKMp0DgiMDm4iYMj70gZWKYbI706tWS" crossorigin="anonymous">
    <!-- <link rel="stylesheet" href="/css/bootstrap.css"> -->
    <link rel="stylesheet" href="css/css.css" type="text/css" />
    <!-- <script type="text/javascript" src="/js/bootstrap.js"></script> -->
    <style>
        div {
            padding: 10px;
            font-size: 16px;
        }
    </style>
</head>

<body>
    <header>
        <nav class="navbar navbar-expand-lg navbar-light bg-light">
            <button type="button" id="showNew" class="btn btn-light">うｐろだ</button>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a id="ajax_get" class="nav-link" href="#">一覧表示</a>
                    </li>
                </ul>
            </div>
        </nav>
    </header>
    <div class="display container-fluid">
        <div class="w-50 p-3" style="background-color: #eee;">
            <!-- action="file_upload.php" -->
            <form enctype="multipart/form-data" method="post" id="myform">
                <!-- <form method="post" action="ajax_post.php" enctype="multipart/form-data"> -->
                <div class="form-group">
                    <label for="date">date</label>
                    <input type="date" class="form-control" id="date" name="date">
                </div>
                <div class="form-group">
                    <label for="dwn_pw">down_pass</label>
                    <input type="text" class="form-control" id="dwn_pw" name="dwn_pw" placeholder="Enter_pass">
                </div>
                <div class="form-group">
                    <label for="del_pw">delete_pw</label>
                    <input type="text" class="form-control" id="del_pw" name="del_pw" placeholder="Enter_pass">
                </div>
                <div class="form-group">
                    <label for="comment">Comment</label>
                    <textarea class="form-control" id="comment" name="comment" rows="1" placeholder="お借りします"></textarea>
                </div>
                <div class="form-group">
                    <input type="file" id="upfile" name="upfile" accept="image/*">
                </div>
                <div class="form-group">
                    <button type="button" id="send" class="btn btn-primary">Submit</button>
                </div>
            </form>
        </div>
        <div class="w-50 p-3" style="background-color: #ddd;">
        </div>
    </div>
    <ul id="echo" class="list-group">
        <!-- データ表示部分 -->
    </ul>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script>
        // // DBから取得したデータを表示する関数
        // function listData(data) {
        //     // 書ける人は書いてみよう
        // }

        // createListTagFromData()
        // データをいい感じのタグに⼊れる関数
        function createListTagFromData(data) {
            // 出⼒⽤の配列を⽤意
            const array = [];
            // 順番にタグの形にして出⼒⽤の配列に追加する
            for (let i = 0; i < data.length; i++) {
                const str =
                    `<li class="list-group-item">
<p>${data[i].id} ${data[i].date}${data[i].dwn_pw}${data[i].del_pw} ${data[i].indate}</p>
<p>${data[i].comment}</p>
<img src="${data[i].upfile}" alt="" height="150px">
</li>`
                array.push(str);
            }
            // 全部追加したらjoin()を使って，配列を連続した⽂字列にする
            return array.join('');
        };
        // // DBからデータを取得する関数
        // function selectData() {
        //     const url = 'ajax_get.php';
        //     $.getJSON(url)
        //         .done(function (data, textStatus, jqXHR) {
        //             console.log(data);
        //         })
        //         .fail(function (jqXHR, textStatus, errorThrown) {
        //         })
        //         .always(function () {
        //         });
        // }

        // getAllDataFromDb()
        // DBからデータを取得する関数
        const getAllDataFromDb = () => {
            const url = 'ajax_get.php';
            $.ajax({
                method: 'GET',
                url: url,
                dataType: 'json',
            }).done(function (data) {
                console.log(data);
                // タグに⼊れる関数にデータを投げ，指定したidの部分に表⽰する
                $('#echo').html(createListTagFromData(data));
            }).fail(function (error) {
                console.log(error);
            }).always(function () {
                console.log('completed!');
            });
        };


        // // DBへデータを登録する関数
        // function insertData() {
        //     // getAllDataFromDb()
        //     // DBからデータを取得する関数
        //     const getAllDataFromDb = () => {
        //         const url = 'ajax_post.php';
        //         //画像データ。getform
        //         var form = $('#myform').get()[0];
        //         var formData = new FormData(form);

        // const value = {
        //     date: $('#date').val(), //PHP􄛷􄛿$_POST['􄜻􄞊􀾡']􄛷􀽷􀽶                
        //     comment: $('#comment').val(),
        //     dwn_pw: $('#dwn_pw').val(), //送信するデータを作る
        //     del_pw: $('#del_pw').val(), //送信するデータを作る
        //     //     image: $('#image').val()
        // };

        //     // データ送信
        //     $.ajax({
        //         dataType: 'json',
        //         url: url,
        //         type: 'POST',
        //         data: formData,
        //         processData: false,
        //         contentType: false
        //     }).done(function (data) {
        //         console.log(data); //􁭱􁪂􄝕􄞊􄝍􄛾􂾲􂙧
        //     }).fail(function (XMLHttpRequest, textStatus, errorThrown) {
        //     }).always(function () {
        //     });
        // }
        insertDataToDb()
        // PHPへデータを送信する関数
        function insertDataToDb() {
            const url = 'ajax_post.php';
            // ファイル諸共にフォームの中⾝を取得する
            const data = new FormData($('#insert_form').get(0));
            // ajaxでデータを投げる
            $.ajax({
                method: 'POST',
                url: url,
                data: data,
                dataType: 'json',
                // ↓この2つはファイルを送信する場合に必須
                processData: false,
                contentType: false,
            }).done(function (data) {
                console.log(data);
                // タグに⼊れる関数にデータを投げ，指定したidの部分に表⽰する
                $('#echo').html(createListTagFromData(data));
                // ボタンの無効化を解除する
                $('button').attr('disabled', false);
            }).fail(function () {
                console.log(error);
            }).always(function () {
                console.log('completed!');
            });
        };
        // // 読み込み時にDBからデータ取得
        // selectData();
        // // 送信でDBにデータ送信
        // $('#send').on('click', function () { // 􃏦􀲙􄝪􄝍􄞁􄜽􄝸􄝑􄜽􁫬􄛻

        //     insertData(); // 􃏦􀲙􃛵􁩘􄜢􁐇􂾜
        //     $('#date').val(); //送信するデータを作る
        //     $('#comment').val(); //PHP􄛷􄛿$_POST['􄜻􄞊􀾡']􄛷􀽷􀽶
        //     $('#dwn_pw').val();
        //     $('#del_pw').val();
        //     $('#image').val();
        // })
        // 読み込み時にデータを取得する関数を実⾏
        getAllDataFromDb();
        // ボタン押したら最新データ取得
        $('#showNew').on('click', function () {
            getAllDataFromDb();
        })
        // 送信ボタンクリック時の処理
        $('#send').on('click', function () {
            // 2重送信をしないためにボタンを無効化する
            $('button').attr('disabled', true);
            // データを送信する関数を実⾏
            insertDataToDb();
            // ⼊⼒欄を空にする処理
            $('#date').val(); //送信するデータを作る
            $('#dwn_pw').val();
            $('#del_pw').val();
            $('#upfile').val();
            $('#comment').val();
        })

    </script>

</body>

</html>